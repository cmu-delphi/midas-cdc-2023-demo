---
format:
  revealjs:
    footer: "Packages for forecasting --- [cmu-delphi.github.io/midas-cdc-2023-demo]{.smaller}"
    logo: "gfx/delphi.jpg"
    embed-resources: false
    chalkboard: true
    width: 1280
    height: 720
    theme: [default, themer.scss]
    fig-format: svg
    html-math-method: mathjax
execute:
  cache: true
editor: source
include-in-header:
  - text: |
      <style type="text/css">
      ul li ul li {
        font-size: 0.85em;
      }
      </style>
---


##  Finding, fetching, and processing epidemiological data with `{epidatr}` and `{epiprocess}`

<br>

#### Logan C. Brooks
#### and CMU's Delphi Group

CDC and MIDAS Forecasting Meeting --- 21 November 2023

```{r}
#| include: false

# setup
pak::pkg_install("epidatr")
library(epidatr)
library(dplyr)

compact_print_tbl <- function(df) {
  # Drop extraneous tibble messages, from
  # https://stackoverflow.com/a/64747799/14401472
  #   - first position stores "tibble <size>" statement
  #   - third position stores column classes
  cat(format(df)[c(-1L, -3L)], sep = "\n")
}
```


## The [Delphi `{epidatr}` package](https://cmu-delphi.github.io/epidatr/) is a new R front-end for the [Delphi Epidata API](https://cmu-delphi.github.io/delphi-epidata/)

- streamlines downloading and usage of data from the [Delphi Epidata
API](https://cmu-delphi.github.io/delphi-epidata/)
  - real-time access to epidemiological surveillance data for influenza, COVID-19, and other diseases
  - data from both official government sources such as the [CDC](https://www.cdc.gov/datastatistics/index.html) and from private partners
  - a historical record of all data available, including corrections and updates, which is useful for backtesting of forecasting models.
- provides a simple R interface to the API, with functions for downloading data, parsing results, and converting to tidy format.
  - the `{epidatr}` package is a complete rewrite of the [`{covidcast}` package](https://cmu-delphi.github.io/covidcast/covidcastR/), with a focus on speed, reliability, and ease of use
  - the {`covidcast`} package is deprecated and will no longer be updated


## Conveniently install in the normal ways

- You can install the stable version of this package from CRAN:

```{r}
#| eval: false
#| echo: true
install.packages("epidatr")
pak::pkg_install("epidatr")
renv::install("epidatr")
```

- Or if you want the development version, install from GitHub:

```{r}
#| eval: false
#| echo: true
pak::pkg_install("cmu-delphi/epidatr@dev")
remotes::install_github("cmu-delphi/epidatr", ref = "dev")
renv::install("cmu-delphi/epidatr@dev")
```

- `{epidatr}` requires a (free) API key for full functionality
  - To generate your key, [register](https://api.delphi.cmu.edu/epidata/admin/registration_form) for a pseudo-anonymous account (see the [general API website](https://cmu-delphi.github.io/delphi-epidata/api/api_keys.html) for details) and use `save_api_key()` for help storing the key.
  - (Note: we also have private endpoints (those prefixed with `pvt_`) that require a separate key to be passed as an argument. These endpoints require data use agreements to access.)

:::


## Example: access HHS hospitalization data

- We can obtain the 7-day average of COVID-19 hospital admissions from the Department of Health & Human Services like so:

```{r}
#| echo: true
#| eval: false
epidata <- pub_covidcast(
  source = "hhs",
  signals = "confirmed_admissions_covid_1d_7dav",
  geo_type = "nation",
  time_type = "day",
  geo_values = "us",
  time_values = epirange(20230101, 20230601)
)
epidata
```

```{r}
#| echo: false
#| eval: true
epidata <- pub_covidcast(
  source = "hhs",
  signals = "confirmed_admissions_covid_1d_7dav",
  geo_type = "nation",
  time_type = "day",
  geo_values = "us",
  time_values = epirange(20230101, 20230601)
)
epidata %>%
  select(geo_value, signal, source, geo_type, time_type, time_value, issue, lag, value, everything()) %>%
  compact_print_tbl()
```


## Access other useful data, including Delphi-exclusive sources

- [`chng`](https://cmu-delphi.github.io/delphi-epidata/api/covidcast-signals/chng.html) from [Change Healthcare](https://www.changehealthcare.com/)
    - Outpatient COVID and influenza signals from insurance claims
- [`doctor-visits`](https://cmu-delphi.github.io/delphi-epidata/api/covidcast-signals/doctor-visits.html) from health system partners
    - COVID signals from insurance claims
- [`fb-survey`](https://cmu-delphi.github.io/delphi-epidata/api/covidcast-signals/fb-survey.html) from the [COVID-19 Trends and Impact Survey](https://delphi.cmu.edu/blog/2020/08/26/covid-19-symptom-surveys-through-facebook/) in collaboration with Facebook
    - Historical behaviors and beliefs signals


## Access more than just COVID data!

```{r}
#| eval: false
#| echo: true
avail_endpoints()
```

```{r}
#| eval: true
#| echo: false
invisible(capture.output(endpts <- avail_endpoints()))
endpts %>%
  filter(startsWith(Endpoint, "pub_"), !startsWith(Endpoint, "pub_covid")) %>%
  compact_print_tbl()
```


## Consider subscribing to the [Delphi API mailing list](https://lists.andrew.cmu.edu/mailman/listinfo/delphi-covidcast-api) to be notified of package updates, new data sources, corrections, and other updates
