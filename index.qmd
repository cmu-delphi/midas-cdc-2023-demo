---
format:
  revealjs:
    footer: "Packages for forecasting --- [cmu-delphi.github.io/midas-cdc-2023-demo]{.smaller}"
    logo: "gfx/delphi.jpg"
    embed-resources: false
    chalkboard: true
    width: 1280
    height: 720
    theme: [default, themer.scss]
    fig-format: svg
    html-math-method: mathjax
execute:
  cache: true
editor: source
include-in-header:
  - text: |
      <style type="text/css">
      ul li ul li {
        font-size: 0.85em;
      }
      </style>
---


##  Finding, fetching, and processing epidemiological data with `{epidatr}` and `{epiprocess}`

<br>

#### Logan C. Brooks
#### and CMU's Delphi Group

CDC and MIDAS Forecasting Meeting --- 21 November 2023


## `{epidatr}`

```{r}
#| include: false

# setup
pak::pkg_install("epidatr")
library(epidatr)
library(dplyr)

compact_print_tbl <- function(df) {
  # Drop extraneous tibble messages, from
  # https://stackoverflow.com/a/64747799/14401472
  #   - first position stores "tibble <size>" statement
  #   - third position stores column classes
  cat(format(df)[c(-1L, -3L)], sep = "\n")
}
```


## The [Delphi `{epidatr}` package](https://cmu-delphi.github.io/epidatr/) is a new R front-end for the [Delphi Epidata API](https://cmu-delphi.github.io/delphi-epidata/)

This package is designed to streamline the downloading and usage of data from the [Delphi Epidata
API](https://cmu-delphi.github.io/delphi-epidata/). It provides a simple R interface to the API, including functions for downloading data, parsing the results, and converting the data into a tidy format.

The API provides real-time access to epidemiological surveillance data for influenza, COVID-19, and other diseases, both from official government sources such as the [CDC](https://www.cdc.gov/datastatistics/index.html) and from private partners. The API stores a historical record of all data, including corrections and updates, which is particularly useful for accurately backtesting forecasting models.


## The `{epidatr}` package is a complete rewrite of the [`{covidcast}` package](https://cmu-delphi.github.io/covidcast/covidcastR/), with a focus on speed, reliability, and ease of use

The {`covidcast`} package is deprecated and will no longer be updated.


## Conveniently install in the normal ways

You can install the stable version of this package from CRAN:

```{r}
#| eval: false
#| echo: true
install.packages("epidatr")
pak::pkg_install("epidatr")
renv::install("epidatr")
```


<br>

Or if you want the development version, install from GitHub:

```{r}
#| eval: false
#| echo: true
pak::pkg_install("cmu-delphi/epidatr")
remotes::install_github("cmu-delphi/epidatr")
renv::install("cmu-delphi/epidatr")
```

## `{epidatr}` requires a (free) API key for full functionality

To generate your key, [register](https://api.delphi.cmu.edu/epidata/admin/registration_form) for a pseudo-anonymous account. See the [general API website](https://cmu-delphi.github.io/delphi-epidata/api/api_keys.html) for details.

<br>

```{r}
#| eval: false
#| echo: true
# This function will guide you in storing your API key.
save_api_key()
```

<br>

::: {style="font-size: 75%;"}

Note: the private endpoints (those prefixed with `pvt_`) require a
separate key to be passed as an argument. These endpoints require
data use agreements to access.

:::


## Access HHS hospitalization data

```{r}
#| echo: true
#| eval: false
# 7-day average of COVID-19 hospital admissions from the Department of Health & Human Services
epidata <- pub_covidcast(
  source = "hhs",
  signals = "confirmed_admissions_covid_1d_7dav",
  geo_type = "nation",
  time_type = "day",
  geo_values = "us",
  time_values = epirange(20230101, 20230601)
)
epidata
```

```{r}
#| echo: false
#| eval: true
epidata <- pub_covidcast(
  source = "hhs",
  signals = "confirmed_admissions_covid_1d_7dav",
  geo_type = "nation",
  time_type = "day",
  geo_values = "us",
  time_values = epirange(20230101, 20230601)
)
epidata %>%
  select(geo_value, signal, source, geo_type, time_type, time_value, issue, lag, value, everything()) %>%
  compact_print_tbl()
```


## Access popular data sources

???


## Access other useful data, including Delphi-exclusive sources

- [`chng`](https://cmu-delphi.github.io/delphi-epidata/api/covidcast-signals/chng.html) from [Change Healthcare](https://www.changehealthcare.com/)
    - Outpatient COVID and flu signals from insurance claims
- [`doctor-visits`](https://cmu-delphi.github.io/delphi-epidata/api/covidcast-signals/doctor-visits.html) from health system partners
    - COVID signals from insurance claims
- [`fb-survey`](https://cmu-delphi.github.io/delphi-epidata/api/covidcast-signals/fb-survey.html) from the [COVID-19 Trends and Impact Survey](https://delphi.cmu.edu/blog/2020/08/26/covid-19-symptom-surveys-through-facebook/) in collaboration with Facebook
    - Historical behaviors and beliefs signals


## Access more than just COVID data!

```{r}
#| eval: false
#| echo: true
avail_endpoints()
```

```{r}
#| eval: true
#| echo: false
invisible(capture.output(endpts <- avail_endpoints()))
endpts %>%
  filter(startsWith(Endpoint, "pub_"), !startsWith(Endpoint, "pub_covid")) %>%
  compact_print_tbl()
```


## Consider subscribing to the [Delphi API mailing list](https://lists.andrew.cmu.edu/mailman/listinfo/delphi-covidcast-api) to be notified of package updates, new data sources, corrections, and other updates
